<html>

<head>
  <title>OoTRR Item Tracker</title>
  <script src="/__/firebase/4.2.0/firebase-app.js"></script>
  <script src="/__/firebase/4.2.0/firebase-auth.js"></script>
  <script src="/__/firebase/4.2.0/firebase-database.js"></script>
  <script src="/__/firebase/init.js"></script>
  <script src="/script/shared.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/items.css">

  <style>
    .big_counter_font {
      font: 24px Impact, sans-serif;
      opacity: 0.75;
    }

    .small_counter_font {
      font: 16px Impact, sans-serif;
      opacity: 1;
    }

    .rewardtext {
      display: inline-block;
      background-size: contain;
      width: 50px;
      height: 18px;
      margin: 3px;
    }

    .stones {
      display: inline-block;
      background-size: contain;
      width: 33px;
      height: 33px;
      margin: 11.5px 1.5px 11.5px 1.5px;
    }

    .majoritem {
      display: inline-block;
      background-size: contain;
      width: 50px;
      height: 50px;
      margin: 3px;
    }

    .dungname-col1 {
      display: inline-block;
      background-size: contain;
      width: 60px;
      height: 15px;
      margin-left: 15px;
    }

    .dungname-col2 {
      display: inline-block;
      background-size: contain;
      width: 75px;
      height: 15px;
      margin-left: 15px;
    }

    .dungname-col3 {
      display: inline-block;
      background-size: contain;
      width: 45px;
      height: 15px;
      margin-left: 15px;
    }

    .keys {
      display: inline-block;
      background-size: contain;
      width: 20px;
      height: 20px;
    }

  .hookshot { background-image: url(../images/hookshot.png) }
  .longshot { background-image: url(../images/longshot.png) }
  </style>
</head>

<body>

  <div id="notInitialized">
    <h2>Room not initialized</h2>
  </div>
  <div class="tracker">

    <!-- Next Row: Medallion Labels -->
    <div class="row">
      <div class="formedlabel cycle">
        <div class="unknowntext rewardtext true"></div>
        <div class="dekutext rewardtext hidden"></div>
        <div class="dctext rewardtext hidden"></div>
        <div class="jabutext rewardtext hidden"></div>
        <div class="foresttext rewardtext hidden"></div>
        <div class="firetext rewardtext hidden"></div>
        <div class="watertext rewardtext hidden"></div>
        <div class="shadowtext rewardtext hidden"></div>
        <div class="spirittext rewardtext hidden"></div>
        <div class="freetext rewardtext hidden"></div>
      </div>
      <div class="firemedlabel cycle">
        <div class="unknowntext rewardtext true"></div>
        <div class="dekutext rewardtext hidden"></div>
        <div class="dctext rewardtext hidden"></div>
        <div class="jabutext rewardtext hidden"></div>
        <div class="foresttext rewardtext hidden"></div>
        <div class="firetext rewardtext hidden"></div>
        <div class="watertext rewardtext hidden"></div>
        <div class="shadowtext rewardtext hidden"></div>
        <div class="spirittext rewardtext hidden"></div>
        <div class="freetext rewardtext hidden"></div>
      </div>
      <div class="watmedlabel cycle">
        <div class="unknowntext rewardtext true"></div>
        <div class="dekutext rewardtext hidden"></div>
        <div class="dctext rewardtext hidden"></div>
        <div class="jabutext rewardtext hidden"></div>
        <div class="foresttext rewardtext hidden"></div>
        <div class="firetext rewardtext hidden"></div>
        <div class="watertext rewardtext hidden"></div>
        <div class="shadowtext rewardtext hidden"></div>
        <div class="spirittext rewardtext hidden"></div>
        <div class="freetext rewardtext hidden"></div>
      </div>
      <div class="shamedlabel cycle">
        <div class="unknowntext rewardtext true"></div>
        <div class="dekutext rewardtext hidden"></div>
        <div class="dctext rewardtext hidden"></div>
        <div class="jabutext rewardtext hidden"></div>
        <div class="foresttext rewardtext hidden"></div>
        <div class="firetext rewardtext hidden"></div>
        <div class="watertext rewardtext hidden"></div>
        <div class="shadowtext rewardtext hidden"></div>
        <div class="spirittext rewardtext hidden"></div>
        <div class="freetext rewardtext hidden"></div>
      </div>
      <div class="spmedlabel cycle">
        <div class="unknowntext rewardtext true"></div>
        <div class="dekutext rewardtext hidden"></div>
        <div class="dctext rewardtext hidden"></div>
        <div class="jabutext rewardtext hidden"></div>
        <div class="foresttext rewardtext hidden"></div>
        <div class="firetext rewardtext hidden"></div>
        <div class="watertext rewardtext hidden"></div>
        <div class="shadowtext rewardtext hidden"></div>
        <div class="spirittext rewardtext hidden"></div>
        <div class="freetext rewardtext hidden"></div>
      </div>
      <div class="limedlabel cycle">
        <div class="unknowntext rewardtext true"></div>
        <div class="dekutext rewardtext hidden"></div>
        <div class="dctext rewardtext hidden"></div>
        <div class="jabutext rewardtext hidden"></div>
        <div class="foresttext rewardtext hidden"></div>
        <div class="firetext rewardtext hidden"></div>
        <div class="watertext rewardtext hidden"></div>
        <div class="shadowtext rewardtext hidden"></div>
        <div class="spirittext rewardtext hidden"></div>
        <div class="freetext rewardtext hidden"></div>
      </div>
    </div>


    <!-- Next Row: Medallions -->
    <div class="row">
      <div class="forestmed majoritem false toggle"></div>
      <div class="firemed majoritem false toggle"></div>
      <div class="watermed majoritem false toggle"></div>
      <div class="shadowmed majoritem false toggle"></div>
      <div class="spiritmed majoritem false toggle"></div>
      <div class="lightmed majoritem false toggle"></div>
    </div>

    <!-- Next Row: Atrade, Skulls, Stones, Bottle, Scale -->
    <div class="row">
      <div class="atrade cycle noloop">
        <div class="atrade0 majoritem false"></div>
        <div class="atrade1 majoritem hidden"></div>
        <div class="atrade2 majoritem hidden"></div>
        <div class="atrade3 majoritem hidden"></div>
        <div class="atrade4 majoritem hidden"></div>
        <div class="atrade5 majoritem hidden"></div>
        <div class="atrade6 majoritem hidden"></div>
        <div class="atrade7 majoritem hidden"></div>
        <div class="atrade8 majoritem hidden"></div>
        <div class="atrade9 majoritem hidden"></div>
        <div class="atrade10 majoritem hidden"></div>
      </div>
      <div class="gst majoritem counters false">
        <div class="counter_text big_counter_font">0</div>
      </div>
      <div class="emerald stones false toggle"></div>
      <div class="ruby stones false toggle"></div>
      <div class="sapphire stones false toggle"></div>
      <div class="bottlecycle cycle noloop">
        <div class="nobottle majoritem false "></div>
        <div class="bottle majoritem hidden"></div>
        <div class="bottleletter majoritem hidden"></div>
      </div>
      <div class="scalecycle cycle noloop">
        <div class="scale0 majoritem false"></div>
        <div class="scale1 majoritem hidden"></div>
        <div class="scale2 majoritem hidden"></div>
      </div>
    </div>

    <!-- Next Row: Slingshot, Bombs, Rang, Str, Lens, Spells -->
    <div class="row">
      <div class="slingshot majoritem false toggle"></div>
      <div class="bombbag majoritem false toggle"></div>
      <div class="boomerang majoritem false toggle"></div>
      <div class="strcycle cycle noloop">
        <div class="str0 majoritem false"></div>
        <div class="str1 majoritem hidden"></div>
        <div class="str2 majoritem hidden"></div>
        <div class="str3 majoritem hidden"></div>
      </div>
      <div class="lens majoritem false toggle"></div>
      <!-- <div class="spellcycle cycle noloop"> -->
      <div class="spellcycle splititem">
        <div class="nospells majoritem false"></div>
        <div class="dins majoritem hidden"></div>
        <div class="farores majoritem hidden"></div>
        <div class="dinsfarores majoritem hidden"></div>
      </div>
    </div>

    <!-- Next Row: Hookshot, Bow, Arrows, Hammer, Boots, Mirror Shield -->
    <div class="row">
      <div class="hslscycle cycle noloop">
        <div class="nohook majoritem false"></div>
        <div class="hookshot majoritem hidden"></div>
        <div class="longshot majoritem hidden"></div>
      </div>
      <div class="bow majoritem false toggle"></div>
      <div class="compositearrows splititem">
        <div class="nomagicarrows majoritem false"></div>
        <div class="firearrows majoritem hidden"></div>
        <div class="lightarrows majoritem hidden"></div>
        <div class="magicarrows majoritem hidden"></div>
      </div>
      <div class="hammer majoritem false toggle"></div>
      <div class="bootcycle splititem">
        <div class="noboots majoritem false"></div>
        <div class="ironboots majoritem hidden"></div>
        <div class="hoverboots majoritem hidden"></div>
        <div class="boots majoritem hidden"></div>
      </div>
      <div class="mirrorshield majoritem false toggle"></div>
    </div>

    <!-- Next Row: Child Trade, Ocarina, Beans, Ksword/Gcard, Tunics, Triforce -->
    <div class="row">
      <div class="ctrade cycle noloop">
        <div class="ctrade0 majoritem false"></div>
        <div class="ctrade1 majoritem hidden"></div>
        <div class="ctrade2 majoritem hidden"></div>
        <div class="ctrade3 majoritem hidden"></div>
        <div class="ctrade4 majoritem hidden"></div>
      </div>
      <div class="ocarina majoritem false toggle"></div>
      <div class="beans majoritem false toggle"></div>
      <div class="dungeonopeners splititem">
        <div class="noswordcard majoritem false"></div>
        <div class="koksword majoritem hidden"></div>
        <div class="gerudocard majoritem hidden"></div>
        <div class="swordcard majoritem hidden"></div>
      </div>
      <div class="tuniccycle splititem">
        <div class="notunics majoritem false"></div>
        <div class="gorontunic majoritem hidden"></div>
        <div class="zoratunic majoritem hidden"></div>
        <div class="tunics majoritem hidden"></div>
      </div>
      <div class="triforce majoritem counters false">
        <div class="counter_text big_counter_font">0</div>
      </div>
    </div>

    <!-- Next Row: Child song tracking -->
    <div class="row">
      <div class="zl majoritem toggle false"></div>
      <div class="epona majoritem toggle false"></div>
      <div class="saria majoritem toggle false"></div>
      <div class="sunsong majoritem toggle false"></div>
      <div class="songoftime majoritem toggle false"></div>
      <div class="storms majoritem toggle false"></div>
    </div>

    <!-- Next Row: Warp Songs -->
    <div class="row">
      <div class="minuet majoritem toggle false"></div>
      <div class="bolero majoritem toggle false"></div>
      <div class="serenade majoritem toggle false"></div>
      <div class="nocturne majoritem toggle false"></div>
      <div class="requiem majoritem toggle false"></div>
      <div class="prelude majoritem toggle false"></div>
    </div>

    <!-- First Row of Keys: Forest, Shadow, Well -->
    <div class="row">
      <div class="forestcycle cycle"><div class="forestn dungname-col1 true"></div><div class="forestmq dungname-col1 hidden"></div></div>
      <div class="forestsk keys counters false"><div class="counter_text small_counter_font">0</div></div>
      <div class="forestbk keys toggle false"></div>

      <div class="shadowcycle cycle"><div class="shadown dungname-col2 true"></div><div class="shadowmq dungname-col2 hidden"></div></div>
      <div class="shadowsk keys counters false"><div class="counter_text small_counter_font">0</div></div>
      <div class="shadowbk keys toggle false"></div>

      <div class="wellcycle cycle"><div class="welln dungname-col3 true"></div><div class="wellmq dungname-col3 hidden"></div></div>
      <div class="wellsk keys counters false"><div class="counter_text small_counter_font">0</div></div>
    </div>

    <!-- Second Row of Keys: Fire, Spirit, Fort -->
    <div class="row">
      <div class="firecycle cycle"><div class="firen dungname-col1 true"></div><div class="firemq dungname-col1 hidden"></div></div>
      <div class="firesk keys counters false"><div class="counter_text small_counter_font">0</div></div>
      <div class="firebk keys toggle false"></div>

      <div class="spiritcycle cycle"><div class="spiritn dungname-col2 true"></div><div class="spiritmq dungname-col2 hidden"></div></div>
      <div class="spiritsk keys counters false"><div class="counter_text small_counter_font">0</div></div>
      <div class="spiritbk keys toggle false"></div>

      <div class="fortcycle cycle"><div class="fort1 dungname-col3 true"></div><div class="fort4 dungname-col3 hidden"></div></div>
      <div class="fortsk keys counters false"><div class="counter_text small_counter_font">0</div></div>
    </div>

    <!-- Last Row of Keys: Water, Ganon, GTG -->
    <div class="row">
      <div class="watercycle cycle"><div class="watern dungname-col1 true"></div><div class="watermq dungname-col1 hidden"></div></div>
      <div class="watersk keys counters false"><div class="counter_text small_counter_font">0</div></div>
      <div class="waterbk keys toggle false"></div>

      <div class="ganoncycle cycle"><div class="ganonn dungname-col2 true"></div><div class="ganonmq dungname-col2 hidden"></div></div>
      <div class="ganonsk keys counters false"><div class="counter_text small_counter_font">0</div></div>
      <div class="ganonbk keys toggle false"></div>

      <div class="gtgcycle cycle"><div class="gtgn dungname-col3 true"></div><div class="gtgmq dungname-col3 hidden"></div></div>
      <div class="gtgsk keys counters false"><div class="counter_text small_counter_font">0</div></div>
    </div>


  </div>
  <div class="room-controls">
    <input id="passcode" type="text" placeholder="Passcode" />
    <button id="setPasscode">Initialize room w/passcode</button>
    <button id="resetRoom">Reset room</button>
    <div id="ownerControls"><button id="destroyRoom">Destroy room</button></div>
    <script>

      // Custom "framework" to handle addClass and removeClass
      "function" !== typeof Array.prototype.indexOf && (Array.prototype.indexOf = function (d) { for (var a = 0; a < this.length; a++)if (this[a] === d) return a; return -1 });
      window.dome = function () {
        function d(a) { for (var b = 0; b < a.length; b++)this[b] = a[b]; this.length = a.length } d.prototype.forEach = function (a) { this.map(a); return this }; d.prototype.map = function (a) { for (var b = [], c = 0; c < this.length; c++)b.push(a.call(this, this[c], c)); return b }; d.prototype.mapOne = function (a) { a = this.map(a); return 1 < a.length ? a : a[0] }; d.prototype.hasClass = function (a) { return this.mapOne(function (b) { return b.classList ? b.classList.contains(a) : !!b.className.match(new RegExp("(\\s|^)" + a + "(\\s|$)")) }) }; d.prototype.addClass =
          function (a) { var b = ""; if ("string" !== typeof a) for (var c = 0; c < a.length; c++)b += " " + a[c]; else b = " " + a; return this.forEach(function (a) { a.className += b }) }; d.prototype.removeClass = function (a) { return this.forEach(function (b) { for (var c = b.className.split(" "), d; -1 < (d = c.indexOf(a));)c = c.slice(0, d).concat(c.slice(++d)); b.className = c.join(" ") }) }; d.prototype.attr = function (a, b) { return "undefined" !== typeof b ? this.forEach(function (c) { c.setAttribute(a, b) }) : this.mapOne(function (b) { return b.getAttribute(a) }) }; d.prototype.on =
            function () { return document.addEventListener ? function (a, b) { return this.forEach(function (c) { c.addEventListener(a, b, !1) }) } : document.attachEvent ? function (a, b) { return this.forEach(function (c) { c.attachEvent("on" + a, b) }) } : function (a, b) { return this.forEach(function (c) { c["on" + a] = b }) } }(); d.prototype.off = function () {
              return document.removeEventListener ? function (a, b) { return this.forEach(function (c) { c.removeEventListener(a, b, !1) }) } : document.detachEvent ? function (a, b) {
                return this.forEach(function (c) {
                  c.detachEvent("on" +
                    a, b)
                })
              } : function (a, b) { return this.forEach(function (b) { b["on" + a] = null }) }
            }(); return { get: function (a) { a = "string" === typeof a ? document.querySelectorAll(a) : a.length ? a : [a]; return new d(a) }, ready: function (a) { "loading" != document.readyState ? a() : document.addEventListener("DOMContentLoaded", a) } }
      }();


      dome.ready(function () {
        dome.get('.toggle').on('touchstart', toggle);
        dome.get('.cycle').on('touchstart', cycle);
        dome.get('.toggle').on('click', toggle);
        dome.get('.cycle').on('click', cycle);
        dome.get('.toggle').on('contextmenu', toggle)
        dome.get('.cycle').on('contextmenu', cycle_reverse);
        dome.get('.counters').on('click', count_up);
        dome.get('.counters').on('contextmenu', count_down);
        dome.get('.splititem').on('click', split_toggle_left);
        dome.get('.splititem').on('contextmenu', split_toggle_right);
        dome.get('#setPasscode').on('click', setPasscode);
        dome.get('#setPasscode').on('touchstart', setPasscode);
        dome.get('#resetRoom').on('click', resetFirebase);
        dome.get('#resetRoom').on('touchstart', resetFirebase);
        dome.get('#destroyRoom').on('click', destroyFirebase);
        dome.get('#destroyRoom').on('touchstart', destroyFirebase);
      });

      // ===================================================
      // ===================================================
      // ===================================================
      // ===================================================
      // ===================================================
      // ===================================================
      // ALSO ADD BADGES
      // ===================================================
      // ===================================================
      // ===================================================
      // ===================================================
      // ===================================================
      // ===================================================

      function split_toggle_left(e) {
        e.preventDefault();
        var curItem = this.classList.item(0);
        var children = this.children;
        // Find current state
        var leftState = !(children.item(1).classList.contains("hidden") && children.item(3).classList.contains("hidden"));
        var rightState = !(children.item(2).classList.contains("hidden") && children.item(3).classList.contains("hidden"));

        // Toggle left state and display correct icon
        for (var i = 0; i < children.length; i++) {
          if (!leftState && !rightState)
            rootRef.child('items').child(curItem).set(children[1].classList.item(0));
          else if (!leftState && rightState)
            rootRef.child('items').child(curItem).set(children[3].classList.item(0));
          else if (leftState && !rightState)
            rootRef.child('items').child(curItem).set(children[0].classList.item(0));
          else if (leftState && rightState)
            rootRef.child('items').child(curItem).set(children[2].classList.item(0));
        }
        return;
      }

      function split_toggle_right(e) {
        e.preventDefault();
        var curItem = this.classList.item(0);
        var children = this.children;
        // Find current state
        var leftState = !(children.item(1).classList.contains("hidden") && children.item(3).classList.contains("hidden"));
        var rightState = !(children.item(2).classList.contains("hidden") && children.item(3).classList.contains("hidden"));

        // Toggle left state and display correct icon
        for (var i = 0; i < children.length; i++) {
          if (!leftState && !rightState)
            rootRef.child('items').child(curItem).set(children[2].classList.item(0));
          else if (!leftState && rightState)
            rootRef.child('items').child(curItem).set(children[0].classList.item(0));
          else if (leftState && !rightState)
            rootRef.child('items').child(curItem).set(children[3].classList.item(0));
          else if (leftState && rightState)
            rootRef.child('items').child(curItem).set(children[1].classList.item(0));
        }
        return;
      }

      function count_up(e) {
        e.preventDefault();
        var curItem = this.classList.item(0);
        var curCount = this.children[0].innerHTML;
        curCount++;
        rootRef.child('items').child(curItem).set(curCount);
      }

      function count_down(e) {
        e.preventDefault();
        var curItem = this.classList.item(0);
        var curCount = this.children[0].innerHTML
        if (curCount == 0) return;
        curCount--;
        rootRef.child('items').child(curItem).set(curCount);
      }

      function cycle(e) {
        e.preventDefault();
        var curItem = this.classList.item(0);
        var children = this.children;
        for (var i = 0; i < children.length; i++) {
          var el = children[i];
          if (!el.classList.contains('hidden')) {
            var elToSet = children[i + 1];
            if (!elToSet) {
              elToSet = children[0];
              if (this.classList.contains('noloop')) {
                elToSet = children[i];
              }
            }
            rootRef.child('items').child(curItem).set(elToSet.classList.item(0));
            return;
          }
        }
      }

      function cycle_reverse(e) {
        e.preventDefault();
        var curItem = this.classList.item(0);
        var children = this.children;
        for (var i = 0; i < children.length; i++) {
          var el = children[i];
          if (!el.classList.contains('hidden')) {
            var elToSet = children[i - 1];
            if (!elToSet) {
              elToSet = children[children.length - 1];
              if (this.classList.contains('noloop')) {
                elToSet = children[0];
              }
            }
            rootRef.child('items').child(curItem).set(elToSet.classList.item(0));
            return;
          }
        }
      }

      function toggle(e) {
        e.preventDefault();
        var curState = !(this.classList.contains("false"));
        var curItem = this.classList.item(0);
        rootRef.child("items").child(curItem).set(!curState);
      }

      function setItemState(item, state) {
        var el = document.querySelectorAll('.' + item)[0];
        if (el.classList.contains('cycle') || el.classList.contains('splititem')) {
          // ====================================================
          for (var i = 0; i < el.children.length; i++) {
            var child = el.children[i];
            if (child.classList.contains(state)) {
              child.classList.remove('hidden');
            } else {
              child.classList.add('hidden');
            }
          }
          if (state === false) {
            el.children[0].classList.remove('hidden');
          }
          // ====================================================
        }
        else if (el.classList.contains('toggle')) {
          if (state) {
            el.classList.remove('false');
          } else {
            el.classList.add('false');
          }
        }
        // else if (el.classList.contains('splititem')) {
        //   for (var i = 0; i < el.children.length; i++) {
        //     var child = el.children[i];
        //     if (child.class)
        //   }
        // }
        else { // Counters
          if (state) {
            el.classList.remove('false');
            el.children[0].innerHTML = state;
            el.children[0].style.visibility = 'visible';
          }
          else {
            el.classList.add('false');
            el.children[0].innerHTML = 0;
            el.children[0].style.visibility = 'hidden';
          }
        }
      }

      function initTracker() {
        var initialized = null;
        rootRef.child('items').on('child_added', function (data) {
          setItemState(data.key, data.val());
        });
        rootRef.child('items').on('child_changed', function (data) {
          setItemState(data.key, data.val());
        });
        rootRef.child('items').on('child_removed', function (data) {
          setItemState(data.key, false);
        });

        rootRef.child('items').on('value', function (snapshot) {
          roomCreated = !!snapshot.val();
        });
        rootRef.child('owner').on('value', function (data) {
          initialized = !!data.val();
          document.getElementById('notInitialized').hidden = initialized;
          document.getElementById('setPasscode').innerText = initialized ? 'Enter passcode' : 'Initialize room w/passcode';
          document.getElementById('ownerControls').hidden = !(initialized && (data.val() === uid));
        });
        if (g_password !== "") {
          console.log("attempting auto login - please wait a few seconds!");
        }
        setTimeout(() => {
          if (g_password === "")
            return;
          if (initialized == false) //create room
          {
            console.log("attempt to create room");
            var editors = {};
            editors[uid] = true;
            rootRef.set({
              owner: uid,
              passcode: g_password,
              editors: editors
            });
            console.log("Created new due password set in url");
          }
          else //add to editors if room already exists
          {
            rootRef.child('editors').child(uid).set(g_password, function (error) {
              if (error) {
                console.log("Did not add to editors on page load");
                console.log(error);
              }
              else {
                console.log("Added to editors successfully due password set in url");
              }
            });
          }
          rootRef.child('owner').on('value', function (data) {
            document.getElementById('notInitialized').hidden = initialized;
            document.getElementById('setPasscode').style.visibility = (initialized) ? "hidden" : "visible";
            document.getElementById('passcode').hidden = initialized
            document.getElementById('ownerControls').hidden = !(initialized && (data.val() === uid));
          });


        }, 4000);
      }

      function resetFirebase() {
        rootRef.child('items').set({});
      }

      function setPasscode() {
        var passcode = document.getElementById("passcode").value;
        if (document.getElementById('notInitialized').hidden) {
          rootRef.child('editors').child(uid).set(passcode);
        } else {
          var editors = {};
          editors[uid] = true;
          rootRef.set({
            owner: uid,
            passcode: passcode,
            editors: editors
          });
        }
      }

      function ready() {
        init(initTracker);
      }

      if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        ready();
      } else {
        document.addEventListener('DOMContentLoaded', ready);
      }


    </script>

</body>
</html>